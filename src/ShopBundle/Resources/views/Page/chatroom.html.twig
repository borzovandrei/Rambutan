{% extends 'ShopBundle:Default:index.html.twig' %}


{% block title %}Чат{% endblock%}

{% block body %}




   <p class="lead">Добро пожаловать в чат!</p>


   {% for chat in chat %}
      <article class="comment" id="comment">
         <p><span class="highlight">{{ chat.author }}</span> {{ chat.message }}</p>
      </article>
   {% else %}
      <p>Вы можете написать тут первым</p>
   {% endfor %}



   <article class="comment" id="comment">
       <div id="messages"></div>
   </article>







   <form id="publish" class="form-inline">
      <input type="text" name="message"/>
      <input type="submit" class="btn btn-primary" value="Отправить"/>
   </form>



   <script>
       const messages = document.getElementById('messages');

       publish.onsubmit = function(){
           var xhr = new XMLHttpRequest();
           xhr.open("POST", '/chat_send/{{ id }}', true);
           xhr.onload = function(){
           };

           xhr.send(JSON.stringify({message: this.elements.message.value}));
           this.elements.message.value = '';
           return false;
       };

       subscribe();

       function subscribe(){

           var xhr = new XMLHttpRequest();
           var timestamp = (new Date()).getTime();
           url = 'http://localhost:8008/sub/' + {{ id }} + "?&v=" + timestamp;
           xhr.open("GET", url, true);
           xhr.onload = function(){
               var authors = document.createElement('div');
               var msgs = document.createElement('div');
               authors.classList.add('chat-author');
               msgs.classList.add('chat-messages');

               authors.textContent = JSON.parse(this.responseText).user_autor;
               msgs.textContent = JSON.parse(this.responseText).message['message'];
               messages.appendChild(authors);
               messages.appendChild(msgs);

               subscribe();
           };
           xhr.onerror = xhr.onabort = function(){
               setTimeout(subscribe, 500);
           };
           xhr.send('');
       }

   </script>


{% endblock %}